name: Code Analysis (Build, Valgrind, Sanitizers)

on:
  push:
  workflow_dispatch:

jobs:
  analysis:
    name: Build and Analyze
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Build Tools, Analyzers, and MPI
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          cmake \
          valgrind \
          mpich \
          libmpich-dev \
          ninja-build # optional, faster builds

    - name: Configure Project (Standard)
      run: |
        mkdir -p build
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DLOG_USE_COLOR=ON

    - name: Build Project
      run: |
        cmake --build build --parallel

    - name: Run Tests (Single-threaded)
      run: |
        ./tests/test.sh ci

    - name: Run Tests under Valgrind (Memcheck)
      run: |
        ./tests/test.sh ci-memcheck

    - name: Run Tests under Valgrind (Helgrind)
      run: |
        ./tests/test.sh ci-helgrind

    - name: Compile with ASan + UBSan
      if: false
      run: |
        cmake -S . -B build-asan \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_FLAGS="-g -O1 -fsanitize=address,undefined -Wall -Wextra -Wpedantic -pthread -I. -Isrc" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined"
        cmake --build build-asan --parallel

    - name: Run Tests with ASan + UBSan
      if: false
      run: |
        ./tests/test.sh ci

    - name: Compile with ThreadSanitizer
      if: false
      run: |
        cmake -S . -B build-tsan \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_FLAGS="-g -O1 -fsanitize=thread -Wall -Wextra -Wpedantic -pthread -I. -Isrc" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread"
        cmake --build build-tsan --parallel

    - name: Run Tests with TSan
      if: false
      run: |
        ./tests/test.sh ci

